rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Sector: Neural_Records
    // Protocol: AGENT_ISOLATION_PROTOCOL_V5.1
    match /users/{userId} {
      // Access granted only to the authenticated identity matching the sector ID
      allow read: if request.auth != null && request.auth.uid == userId;
      
      // Validation protocols for V5.1 Data Integrity & Adaptive Industrial Limits
      allow write: if request.auth != null && request.auth.uid == userId
                   && (request.resource.data.get('currency', 0) is number && request.resource.data.get('currency', 0) >= 0)
                   && (request.resource.data.get('displayName', '') is string)
                   && (request.resource.data.get('photoURL', '') is string)
                   && (request.resource.data.get('miningMultiplierLevel', 1) is number && request.resource.data.get('miningMultiplierLevel', 1) >= 1)
                   && (request.resource.data.get('inventoryCapacityLevel', 1) is number && request.resource.data.get('inventoryCapacityLevel', 1) >= 1)
                   && (request.resource.data.get('inventory', []) is list && 
                       request.resource.data.get('inventory', []).size() <= (25 + (request.resource.data.get('inventoryCapacityLevel', 1) - 1) * 5));
    }
    
    // Default Protocol: TOTAL_DENIAL
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
